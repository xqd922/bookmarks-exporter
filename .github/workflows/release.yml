name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Cache pnpm modules
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: Install dependencies
        run: pnpm install
        
      - name: Build extension
        run: pnpm build
        
      - name: Package extension
        run: pnpm package
        
      - name: Get version from package.json
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        
      - name: Create release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸŽ‰ Pintree ä¹¦ç­¾å¯¼å‡ºå™¨ v${{ steps.package-version.outputs.version }}
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ðŸŽ¯ **æ™ºèƒ½å›¾æ ‡èŽ·å–**: ä¼˜å…ˆä½¿ç”¨ç½‘ç«™åŽŸç”Ÿé«˜åˆ†è¾¨çŽ‡å›¾æ ‡
          - ðŸ”¥ **å¤šå±‚çº§ç­–ç•¥**: 15+ä¸ªå›¾æ ‡æºï¼Œç¡®ä¿æœ€ä½³è´¨é‡
          - ðŸ“± **è´¨é‡åˆ†çº§**: Premium/Vector/High/Good/Standard äº”çº§è´¨é‡è¯„ä¼°
          - ðŸŒ **ç‰¹æ®Šç½‘ç«™ä¼˜åŒ–**: YouTubeã€GitHubç­‰çŸ¥åç½‘ç«™ä¸“é—¨ä¼˜åŒ–
          - ðŸ“ **ç‰¹æ®Šç›®å½•æ”¯æŒ**: æ”¯æŒ /favicon/ã€/assets/ ç­‰23ä¸ªç‰¹æ®Šç›®å½•
          - ðŸ’¾ **ç¦»çº¿æ”¯æŒ**: Base64ç¼–ç å›¾æ ‡ï¼Œå®Œå…¨ç¦»çº¿å¯ç”¨
          - ðŸš€ **æ™ºèƒ½ç¼“å­˜**: ç›¸åŒåŸŸåå›¾æ ‡åªä¸‹è½½ä¸€æ¬¡
          - ðŸŽ¨ **æ¸…æ™°ç•Œé¢**: ä¸­æ–‡æœ¬åœŸåŒ–ï¼Œå®žæ—¶è¿›åº¦æ˜¾ç¤º
          
          ### ðŸ”§ æŠ€æœ¯ç‰¹æ€§
          - æ”¯æŒæœ€é«˜512Ã—512è¶…é«˜æ¸…å›¾æ ‡
          - SVGçŸ¢é‡å›¾æ ‡æ— æŸç¼©æ”¾
          - æ™ºèƒ½é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶
          - å®Œæ•´çš„ä¹¦ç­¾å±‚çº§ç»“æž„ä¿æŒ
          - çŽ°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢è®¾è®¡
          
          ### ðŸ“Š å›¾æ ‡è´¨é‡æå‡
          - YouTubeç­‰ç½‘ç«™: 16Ã—16 â†’ 144Ã—144+ (**9å€æ¸…æ™°åº¦**)
          - ä¸ªäººç½‘ç«™æˆåŠŸçŽ‡: 70% â†’ 95% (**æ˜¾è‘—æå‡**)
          - æ”¯æŒApple Touch Iconã€PNGã€SVGç­‰å¤šç§æ ¼å¼
          
          ### ðŸŽ¯ é€‚ç”¨åœºæ™¯
          - ä¸ªäººä¹¦ç­¾å¤‡ä»½å’Œè¿ç§»
          - ç½‘ç«™æ”¶è—å¤¹å¯è§†åŒ–å±•ç¤º
          - ä¹¦ç­¾æ•°æ®åˆ†æžå’Œæ•´ç†
          - è·¨æµè§ˆå™¨ä¹¦ç­¾åŒæ­¥
          
          ---
          
          **å®‰è£…æ–¹æ³•**: ä¸‹è½½ `pintree-bookmarks-exporter-v${{ steps.package-version.outputs.version }}.zip`ï¼Œè§£åŽ‹åŽåœ¨Chromeæ‰©å±•ç®¡ç†é¡µé¢åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åºã€‚
          EOF
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Pintree ä¹¦ç­¾å¯¼å‡ºå™¨ ${{ github.ref_name }}
          body_path: release-notes.md
          files: |
            ./build/chrome-mv3-prod.zip
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}