# ğŸ“‹ Pintree ä¹¦ç­¾å¯¼å‡ºå™¨ - ç³»ç»Ÿæ¶æ„ä¸é€»è¾‘æµç¨‹æ–‡æ¡£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒæ¨¡å—ç»“æ„
```
src/
â”œâ”€â”€ popup/                    # ç”¨æˆ·ç•Œé¢å±‚
â”‚   â”œâ”€â”€ index.tsx            # è·¯ç”±å…¥å£
â”‚   â”œâ”€â”€ home.tsx             # é¦–é¡µç•Œé¢
â”‚   â”œâ”€â”€ bookmark.tsx         # ä¹¦ç­¾é€‰æ‹©é¡µé¢
â”‚   â”œâ”€â”€ export.tsx           # å¯¼å‡ºå¤„ç†é¡µé¢
â”‚   â””â”€â”€ finish.tsx           # å®Œæˆä¸‹è½½é¡µé¢
â”œâ”€â”€ utils/                   # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ index.ts             # å›¾æ ‡å¤„ç†æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ tree.ts              # æ ‘å½¢æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ wrapper.ts           # ç½‘ç»œè¯·æ±‚å°è£…
â”‚   â””â”€â”€ bookmark/
â”‚       â””â”€â”€ chrome.ts        # Chromeä¹¦ç­¾API
â”œâ”€â”€ context/                 # çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ app-context.tsx      # å…¨å±€åº”ç”¨çŠ¶æ€
â”œâ”€â”€ components/              # UIç»„ä»¶
â””â”€â”€ types/                   # ç±»å‹å®šä¹‰
```

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»æ‰©å±•å›¾æ ‡] --> B[åŠ è½½é¦–é¡µ home.tsx]
    B --> C[æ˜¾ç¤ºåŠŸèƒ½ä»‹ç»å’Œå¼€å§‹æŒ‰é’®]
    C --> D[ç”¨æˆ·ç‚¹å‡»"å¼€å§‹å¯¼å‡ºä¹¦ç­¾"]
    D --> E[è·¯ç”±è·³è½¬åˆ° /bookmark]
```

**æŠ€æœ¯å®ç°**:
- ä½¿ç”¨ React Router è¿›è¡Œé¡µé¢è·¯ç”±ç®¡ç†
- AppContext æä¾›å…¨å±€çŠ¶æ€ç®¡ç†
- Plasmo æ¡†æ¶å¤„ç†Chromeæ‰©å±•ç”Ÿå‘½å‘¨æœŸ

### 2. ä¹¦ç­¾è·å–ä¸é€‰æ‹©æµç¨‹

```mermaid
graph TD
    A[è¿›å…¥ä¹¦ç­¾é€‰æ‹©é¡µé¢] --> B[è°ƒç”¨ getChromeBookmarks()]
    B --> C[Chrome API: chrome.bookmarks.getTree()]
    C --> D[é€’å½’å¤„ç†ä¹¦ç­¾æ ‘ç»“æ„]
    D --> E[æ ‡è®°èŠ‚ç‚¹ç±»å‹: folder/link]
    E --> F[æ¸²æŸ“å¯é€‰æ‹©çš„ä¹¦ç­¾æ ‘]
    F --> G[ç”¨æˆ·å‹¾é€‰è¦å¯¼å‡ºçš„ä¹¦ç­¾]
    G --> H[éªŒè¯é€‰æ‹©å¹¶å¯ç”¨ç»§ç»­æŒ‰é’®]
    H --> I[ç‚¹å‡»ç»§ç»­ï¼Œè·³è½¬åˆ°å¯¼å‡ºé¡µé¢]
```

**æ ¸å¿ƒä»£ç é€»è¾‘**:
```typescript
// 1. è·å–Chromeä¹¦ç­¾
const getChromeBookmarks = async () => {
  return new Promise((resolve, reject) => {
    chrome.bookmarks.getTree((bookmarks) => {
      if (chrome.runtime.lastError) {
        reject(chrome.runtime.lastError)
      } else {
        resolve(bookmarks)
      }
    });
  });
};

// 2. é€’å½’å¤„ç†ä¹¦ç­¾ç»“æ„
const bookmarks = await recursiveChange<TreeDataNode, ChangedTreeData>(
  result[0].children,
  async (item, _index: number) => ({
    ...item,
    type: item?.children ? "folder" : "link"
  })
)

// 3. ç”¨æˆ·é€‰æ‹©å¤„ç†
const handleExportBookmarks = () => {
  const result = recursiveFind<TreeDataNode>(data, (item, _index: number) =>
    checkedKeys.includes(item.id)
  )
  setTreeData(result)
  navigate("/export")
}
```

### 3. é«˜æ¸…å›¾æ ‡è·å–æµç¨‹

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒåˆ›æ–°éƒ¨åˆ†ï¼Œé‡‡ç”¨å¤šå±‚çº§ç­–ç•¥ç¡®ä¿å›¾æ ‡è´¨é‡ï¼š

```mermaid
graph TD
    A[å¼€å§‹å›¾æ ‡è·å–] --> B[æ£€æŸ¥åŸŸåç¼“å­˜]
    B -->|ç¼“å­˜å‘½ä¸­| C[è¿”å›ç¼“å­˜ç»“æœ]
    B -->|ç¼“å­˜æœªå‘½ä¸­| D[ç¬¬ä¸€ä¼˜å…ˆçº§: åŸç”Ÿé«˜åˆ†è¾¨ç‡å›¾æ ‡]
    
    D --> E[å°è¯• Apple Touch Icon 180x180]
    E -->|æˆåŠŸ| F[è´¨é‡è¯„çº§: Premium]
    E -->|å¤±è´¥| G[å°è¯• Apple Touch Icon 152x152]
    G -->|æˆåŠŸ| H[è´¨é‡è¯„çº§: High]
    G -->|å¤±è´¥| I[å°è¯•å…¶ä»–é«˜åˆ†è¾¨ç‡PNG]
    I -->|æˆåŠŸ| J[è´¨é‡è¯„çº§: High]
    I -->|å¤±è´¥| K[å°è¯•SVGçŸ¢é‡å›¾æ ‡]
    K -->|æˆåŠŸ| L[è´¨é‡è¯„çº§: Vector]
    K -->|å¤±è´¥| M[ç¬¬äºŒä¼˜å…ˆçº§: ç¬¬ä¸‰æ–¹æœåŠ¡]
    
    M --> N[å°è¯• Clearbit Logo API]
    N -->|æˆåŠŸ| O[è´¨é‡è¯„çº§: Premium]
    N -->|å¤±è´¥| P[å°è¯• DuckDuckGo Icon Service]
    P -->|æˆåŠŸ| Q[è´¨é‡è¯„çº§: High]
    P -->|å¤±è´¥| R[å°è¯•å…¶ä»–ç¬¬ä¸‰æ–¹æœåŠ¡]
    R -->|æˆåŠŸ| S[è´¨é‡è¯„çº§: Standard]
    R -->|å¤±è´¥| T[ç¬¬ä¸‰ä¼˜å…ˆçº§: Google Favicon]
    
    T --> U[å°è¯• Google 128x128]
    U -->|æˆåŠŸ| V[è´¨é‡è¯„çº§: High]
    U -->|å¤±è´¥| W[å°è¯• Google 96x96]
    W -->|æˆåŠŸ| X[è´¨é‡è¯„çº§: Standard]
    W -->|å¤±è´¥| Y[å°è¯• Google 64x64]
    Y -->|æˆåŠŸ| Z[è´¨é‡è¯„çº§: Standard]
    Y -->|å¤±è´¥| AA[è¿”å›ç©ºç»“æœ]
    
    F --> BB[è½¬æ¢ä¸ºBase64]
    H --> BB
    J --> BB
    L --> BB
    O --> BB
    Q --> BB
    S --> BB
    V --> BB
    X --> BB
    Z --> BB
    
    BB --> CC[ç¼“å­˜ç»“æœ]
    CC --> DD[è¿”å›å›¾æ ‡æ•°æ®]
```

**æ ¸å¿ƒæŠ€æœ¯å®ç°**:

#### 3.1 å¤šæºå›¾æ ‡URLç”Ÿæˆ
```typescript
// åŸç”Ÿé«˜åˆ†è¾¨ç‡å›¾æ ‡URLsï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
export const getCommonIconUrls = (url: string): string[] => {
  const domain = new URL(url).origin;
  return [
    `${domain}/apple-touch-icon-180x180.png`,  // æœ€é«˜è´¨é‡
    `${domain}/apple-touch-icon-152x152.png`,  // é«˜è´¨é‡
    `${domain}/icon-192x192.png`,              // é«˜åˆ†è¾¨ç‡
    `${domain}/favicon.svg`,                   // çŸ¢é‡å›¾æ ‡
    `${domain}/favicon-96x96.png`,             // æ ‡å‡†æ¸…æ™°
    `${domain}/favicon.ico`,                   // ä¼ ç»Ÿæ ¼å¼
    // ... æ›´å¤šæ ¼å¼
  ];
}

// ç¬¬ä¸‰æ–¹é«˜è´¨é‡æœåŠ¡URLs
export const getThirdPartyIconUrls = (url: string): string[] => {
  const domain = new URL(url).hostname;
  return [
    `https://logo.clearbit.com/${domain}`,           // å“ç‰ŒLogo
    `https://icons.duckduckgo.com/ip3/${domain}.ico`, // é«˜åˆ†è¾¨ç‡
    `https://besticon-demo.herokuapp.com/icon?url=${encodeURIComponent(url)}&size=128`,
    // ... æ›´å¤šæœåŠ¡
  ];
}
```

#### 3.2 æ™ºèƒ½å›¾æ ‡è·å–ç®—æ³•
```typescript
export const getLogoUrl = async (url: string) => {
  console.log(`Starting high-resolution icon search for: ${url}`);
  
  // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šåŸç”Ÿé«˜åˆ†è¾¨ç‡å›¾æ ‡
  const commonIconUrls = getCommonIconUrls(url);
  for (const iconUrl of commonIconUrls) {
    try {
      const response = await fetchWrapper(iconUrl, { timeout: 5000 });
      const contentType = response.headers.get('content-type');
      
      if (contentType && contentType.includes('image')) {
        console.log(`Found native high-res icon: ${iconUrl}`);
        return iconUrl;
      }
    } catch (error) {
      continue; // å°è¯•ä¸‹ä¸€ä¸ª
    }
  }
  
  // ç¬¬äºŒä¼˜å…ˆçº§ï¼šç¬¬ä¸‰æ–¹æœåŠ¡
  // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šGoogleå¤šå°ºå¯¸
  // ... è¯¦ç»†å®ç°
}
```

#### 3.3 é«˜è´¨é‡Base64è½¬æ¢
```typescript
export const logoToBase64 = async (logoUrl: string) => {
  const response = await fetchWrapper(logoUrl, { timeout: 10000 });
  const arrayBuffer = await response.arrayBuffer();
  
  // æ™ºèƒ½MIMEç±»å‹æ£€æµ‹
  let mimeType = response.headers.get('content-type') || '';
  if (!mimeType) {
    if (logoUrl.includes('.png')) mimeType = 'image/png';
    else if (logoUrl.includes('.svg')) mimeType = 'image/svg+xml';
    // ... æ›´å¤šæ ¼å¼æ£€æµ‹
  }
  
  // é«˜æ•ˆåˆ†å—è½¬æ¢ï¼Œé¿å…å¤§æ–‡ä»¶å†…å­˜é—®é¢˜
  const uint8Array = new Uint8Array(arrayBuffer);
  let binaryString = '';
  const chunkSize = 8192;
  
  for (let i = 0; i < uint8Array.length; i += chunkSize) {
    const chunk = uint8Array.subarray(i, i + chunkSize);
    binaryString += String.fromCharCode.apply(null, Array.from(chunk));
  }
  
  const base64 = btoa(binaryString);
  return `data:${mimeType};base64,${base64}`;
}
```

### 4. å¯¼å‡ºå¤„ç†æµç¨‹

```mermaid
graph TD
    A[è¿›å…¥å¯¼å‡ºé¡µé¢] --> B[æ¸…ç†å›¾æ ‡ç¼“å­˜]
    B --> C[è®¡ç®—æ€»é“¾æ¥æ•°é‡]
    C --> D[åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º]
    D --> E[å¼€å§‹é€’å½’å¤„ç†ä¹¦ç­¾æ ‘]
    
    E --> F[éå†æ¯ä¸ªä¹¦ç­¾é¡¹]
    F -->|æ–‡ä»¶å¤¹| G[ä¿ç•™æ–‡ä»¶å¤¹ç»“æ„]
    F -->|é“¾æ¥| H[è·å–é«˜æ¸…å›¾æ ‡]
    
    H --> I[è°ƒç”¨ processIconWithFallback]
    I --> J[æ£€æŸ¥åŸŸåç¼“å­˜]
    J -->|ç¼“å­˜å‘½ä¸­| K[ä½¿ç”¨ç¼“å­˜å›¾æ ‡]
    J -->|ç¼“å­˜æœªå‘½ä¸­| L[æ‰§è¡Œå›¾æ ‡è·å–æµç¨‹]
    
    L --> M[è·å–å›¾æ ‡URL]
    M --> N[è½¬æ¢ä¸ºBase64]
    N --> O[è´¨é‡è¯„ä¼°]
    O --> P[ç¼“å­˜ç»“æœ]
    P --> Q[æ›´æ–°è¿›åº¦æ˜¾ç¤º]
    
    Q --> R[ç»§ç»­ä¸‹ä¸€ä¸ªä¹¦ç­¾]
    R -->|æœªå®Œæˆ| F
    R -->|å®Œæˆ| S[ç”Ÿæˆæœ€ç»ˆJSONæ•°æ®]
    S --> T[è·³è½¬åˆ°å®Œæˆé¡µé¢]
```

**æ ¸å¿ƒå¤„ç†é€»è¾‘**:
```typescript
const exportData = async () => {
  clearIconCache(); // æ¸…ç†ç¼“å­˜
  
  const total = countLinks(treeData as ChangedTreeData[]);
  setTotalCount(total);
  
  let processed = 0;
  
  // é€’å½’å¤„ç†ä¹¦ç­¾æ ‘
  const bookmarks = await recursiveChange<ChangedTreeData, ExportTreeDataProps>(
    treeData as ChangedTreeData[], 
    async (item, _index: number) => {
      if (item.type === "link") {
        setStatusText(`æ­£åœ¨è·å–é«˜æ¸…å›¾æ ‡: ${item.title}`);
        
        // æ ¸å¿ƒå›¾æ ‡å¤„ç†
        const iconData = await processIconWithFallback(item.url);
        
        processed++;
        setProcessedCount(processed);
        const progressPercent = Math.floor((processed / total) * 80) + 20;
        setProgress(progressPercent);
        
        // è´¨é‡åé¦ˆ
        const qualityText = iconData.quality === 'premium' ? '(é«˜å“è´¨)' : 
                           iconData.quality === 'vector' ? '(çŸ¢é‡)' : 
                           iconData.quality === 'high' ? '(é«˜æ¸…)' : '';
        
        return {
          type: item.type,
          addDate: item.dateAdded,
          title: item.title,
          ...iconData, // icon, iconUrl, quality
          url: item.url
        }
      }
      
      // æ–‡ä»¶å¤¹å¤„ç†
      return {
        type: item.type,
        addDate: item.dateAdded,
        title: item.title,
        url: item.url
      }
    }
  )
  
  setTreeData(bookmarks);
}
```

### 5. ç¼“å­˜æœºåˆ¶

```typescript
// å…¨å±€å›¾æ ‡ç¼“å­˜
const iconCache = new Map<string, { icon?: string; iconUrl?: string; quality?: string }>();

// ç¼“å­˜ç­–ç•¥
export const processIconWithFallback = async (url: string) => {
  const domain = new URL(url).hostname;
  
  // æ£€æŸ¥ç¼“å­˜
  if (iconCache.has(domain)) {
    return iconCache.get(domain)!;
  }
  
  // è·å–å¹¶ç¼“å­˜ç»“æœ
  const result = await getIconWithQuality(url);
  iconCache.set(domain, result);
  
  return result;
}
```

### 6. ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

```typescript
// å¢å¼ºçš„ç½‘ç»œè¯·æ±‚åŒ…è£…å™¨
export async function fetchWrapper(url: string, options: FetchOptions = {}) {
  const { timeout = 10000, retries = 2, ...fetchOptions } = options;
  
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      const response = await fetch(url, {
        method: fetchOptions.method || 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
          ...fetchOptions.headers
        },
        body: fetchOptions.body,
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      return response;
    } catch (error) {
      if (attempt === retries) {
        throw new Error(`Fetch failed after ${retries + 1} attempts: ${error}`);
      }
      
      // æŒ‡æ•°é€€é¿é‡è¯•
      await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
    }
  }
}
```

### 7. æœ€ç»ˆæ–‡ä»¶ç”Ÿæˆ

```typescript
// å®Œæˆé¡µé¢çš„ä¸‹è½½é€»è¾‘
const onDownload = () => {
  const data = JSON.stringify(treeData, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "pintree.json";
  a.click();
  URL.revokeObjectURL(url);
}
```

## ğŸ“Š æ•°æ®æµè½¬å›¾

```
ç”¨æˆ·é€‰æ‹©ä¹¦ç­¾ â†’ AppContextçŠ¶æ€ â†’ å¯¼å‡ºå¤„ç† â†’ å›¾æ ‡è·å– â†’ Base64è½¬æ¢ â†’ JSONç”Ÿæˆ â†’ æ–‡ä»¶ä¸‹è½½
     â†“              â†“              â†“           â†“            â†“            â†“           â†“
  bookmark.tsx â†’ app-context â†’ export.tsx â†’ utils/index â†’ logoToBase64 â†’ finish.tsx â†’ ç”¨æˆ·è®¾å¤‡
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜ä¼˜åŒ–
- **åŸŸåçº§ç¼“å­˜**: ç›¸åŒåŸŸåçš„å›¾æ ‡åªè·å–ä¸€æ¬¡
- **å†…å­˜ç®¡ç†**: å¤„ç†å®Œæˆåå¯æ¸…ç†ç¼“å­˜
- **ç¼“å­˜ç»Ÿè®¡**: æä¾›ç¼“å­˜ä½¿ç”¨æƒ…å†µç›‘æ§

### 2. å¹¶å‘æ§åˆ¶
- **è¶…æ—¶æœºåˆ¶**: æ¯ä¸ªè¯·æ±‚5-10ç§’è¶…æ—¶
- **å¿«é€Ÿå¤±è´¥**: å¤±è´¥åç«‹å³å°è¯•ä¸‹ä¸€ä¸ªæº
- **é‡è¯•ç­–ç•¥**: æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

### 3. ç”¨æˆ·ä½“éªŒ
- **å®æ—¶è¿›åº¦**: æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œå½“å‰çŠ¶æ€
- **è´¨é‡åé¦ˆ**: æ˜¾ç¤ºè·å–åˆ°çš„å›¾æ ‡è´¨é‡ç­‰çº§
- **é”™è¯¯å®¹é”™**: å•ä¸ªå›¾æ ‡å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹

## ğŸ”§ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. ç½‘ç»œé”™è¯¯
- è¶…æ—¶è‡ªåŠ¨é‡è¯•
- å¤šæºå¤‡ç”¨æ–¹æ¡ˆ
- é™çº§å¤„ç†ç­–ç•¥

### 2. æ•°æ®é”™è¯¯
- ç±»å‹éªŒè¯
- æ ¼å¼æ£€æŸ¥
- é»˜è®¤å€¼å¤„ç†

### 3. ç”¨æˆ·é”™è¯¯
- è¾“å…¥éªŒè¯
- çŠ¶æ€æ£€æŸ¥
- å‹å¥½æç¤º

è¿™ä¸ªç³»ç»Ÿé€šè¿‡å¤šå±‚çº§çš„å›¾æ ‡è·å–ç­–ç•¥ã€æ™ºèƒ½ç¼“å­˜æœºåˆ¶å’Œå®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿè·å¾—æœ€é«˜è´¨é‡çš„ä¹¦ç­¾å¯¼å‡ºä½“éªŒã€‚